name: Deploy DigitalOcean App Platform

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-do-app-platform
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Trigger DO App Platform deployment
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          DO_APP_ID: d51e20ff-1eb7-4f57-90fc-d6938cd30017
        run: |
          if [ -z "$DO_API_TOKEN" ]; then
            echo "Missing DO_API_TOKEN secret" >&2
            exit 1
          fi

          echo "Triggering redeploy for app $DO_APP_ID"

          # Create a new deployment (equivalent to clicking Deploy Latest)
          resp=$(curl -sS -X POST \
            -H "Authorization: Bearer ${DO_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/apps/${DO_APP_ID}/deployments" \
            -d '{"force_build":true}'
          )

          dep_id=$(echo "$resp" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('deployment',{}).get('id',''))")
          if [ -z "$dep_id" ]; then
            echo "Failed to create deployment. Response:" >&2
            echo "$resp" >&2
            exit 1
          fi

          echo "deployment_id=$dep_id"

          echo "Polling deployment status..."
          for i in $(seq 1 60); do
            d=$(curl -sS \
              -H "Authorization: Bearer ${DO_API_TOKEN}" \
              "https://api.digitalocean.com/v2/apps/${DO_APP_ID}/deployments/${dep_id}" \
            )

            phase=$(echo "$d" | python3 -c "import json,sys; j=json.load(sys.stdin); print(j.get('deployment',{}).get('phase',''))")
            echo "[$i/60] phase=$phase"

            if [ "$phase" = "ACTIVE" ]; then
              echo "Deployment is ACTIVE"
              exit 0
            fi
            if [ "$phase" = "ERROR" ] || [ "$phase" = "FAILED" ] || [ "$phase" = "CANCELED" ]; then
              echo "Deployment failed." >&2
              echo "$d" | python3 -c "import json,sys; j=json.load(sys.stdin); d=j.get('deployment',{}); print('phase:', d.get('phase')); ss=(d.get('progress',{}) or {}).get('summary_steps',[]) or []; [print(f\"- {s.get('name')} [{s.get('status')}] ({s.get('component_name')}): {(s.get('reason') or {}).get('message')}\") for s in ss]"
              exit 1
            fi

            sleep 10
          done

          echo "Timed out waiting for deployment to become ACTIVE" >&2
          exit 1
