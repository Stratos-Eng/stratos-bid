name: Configure Spaces CORS

"on":
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  cors:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Install awscli
        run: |
          python3 -m pip install --upgrade pip
          pip install awscli

      - name: Apply CORS policy to Spaces bucket
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_DEFAULT_REGION: ${{ secrets.DO_SPACES_REGION }}
          DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          DO_SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$DO_SPACES_BUCKET" ]; then
            echo "Missing Spaces credentials in secrets (DO_SPACES_KEY/DO_SPACES_SECRET/DO_SPACES_BUCKET)" >&2
            exit 1
          fi

          # Prefer a bare regional endpoint for S3 API calls.
          endpoint="${DO_SPACES_ENDPOINT:-https://${AWS_DEFAULT_REGION}.digitaloceanspaces.com}"
          # Strip protocol + path
          host="${endpoint#https://}"
          host="${host#http://}"
          host="${host%%/*}"
          # Strip bucket prefix if present
          host="${host#${DO_SPACES_BUCKET}.}"
          endpoint="https://${host}"

          echo "Using endpoint: $endpoint"
          echo "Applying CORS to bucket: $DO_SPACES_BUCKET"

          cat > cors.json <<'JSON'
{
  "CORSRules": [
    {
      "AllowedOrigins": [
        "https://app.stratos.to",
        "http://localhost:3000"
      ],
      "AllowedMethods": [
        "GET",
        "PUT",
        "POST",
        "HEAD"
      ],
      "AllowedHeaders": [
        "*"
      ],
      "ExposeHeaders": [
        "ETag"
      ],
      "MaxAgeSeconds": 3000
    }
  ]
}
JSON

          aws --endpoint-url "$endpoint" s3api put-bucket-cors \
            --bucket "$DO_SPACES_BUCKET" \
            --cors-configuration file://cors.json

          echo "CORS applied."